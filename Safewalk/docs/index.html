<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description"
        content="Safewalk â€” instant SOS emergency help. Press the button to trigger an alarm, share your location, and alert your emergency contact." />
    <title>Safewalk â€” Emergency SOS</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="manifest" href="manifest.json" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
</head>

<body>

    <header>
        <div class="logo-icon" aria-hidden="true">ğŸ›¡ï¸</div>
        <div class="logo-text">Safe<span>walk</span></div>
    </header>

    <main>

        <!-- Emergency Contact Setup -->
        <div class="card">
            <div class="card-title">Emergency Contact</div>
            <div class="contact-row">
                <input type="tel" id="contact-input" placeholder="+1 (555) 000-0000" autocomplete="tel"
                    aria-label="Emergency contact phone number" />
                <button class="btn-save" id="save-btn" onclick="saveContact()">Save</button>
            </div>
            <div class="contact-saved" id="contact-saved">
                <span>âœ“</span> <span id="saved-number"></span>
            </div>
        </div>

        <!-- SOS Button -->
        <div class="sos-section">
            <div class="sos-ring">
                <button id="sos-btn" onclick="triggerSOS()" aria-label="SOS Emergency Button">SOS</button>
            </div>
            <p class="sos-hint">Press and hold in an emergency</p>
            <button id="stop-btn" onclick="stopAlarm()" aria-label="Stop alarm">
                <span>â¹</span> Stop Alarm
            </button>
        </div>

        <!-- Error message -->
        <div class="error-msg" id="error-msg"></div>

        <!-- Status / Info after SOS triggered -->
        <div class="card" id="status-card">
            <div class="card-title">Emergency Status</div>

            <div class="status-row" id="alarm-status" style="display:none">
                <div class="status-icon red">ğŸ””</div>
                <div>
                    <div class="status-label">Alarm</div>
                    <div class="status-value" id="alarm-text">Playingâ€¦</div>
                </div>
            </div>

            <div class="status-row" id="location-status" style="display:none">
                <div class="status-icon green">ğŸ“</div>
                <div>
                    <div class="status-label">Your Location</div>
                    <div class="status-value" id="location-text">Fetching GPSâ€¦</div>
                </div>
            </div>

            <div class="status-row" id="contact-status" style="display:none">
                <div class="status-icon red">ğŸ“±</div>
                <div>
                    <div class="status-label">Contact</div>
                    <div class="status-value" id="contact-text">â€”</div>
                </div>
            </div>

        </div>

    </main>

    <footer>
        Safewalk &mdash; Stay safe, always.
    </footer>

    <!-- â”€â”€ Audio element for alarm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <audio id="alarm-audio" src="alarm.wav" loop preload="auto"></audio>

    <script>
        // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let alarmPlaying = false;
        const alarmAudio = document.getElementById('alarm-audio');

        // â”€â”€ On page load: restore saved contact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        (function init() {
            const saved = localStorage.getItem('sw_emergency_contact');
            if (saved) {
                document.getElementById('contact-input').value = saved;
                showSavedBadge(saved);
            }
        })();

        // â”€â”€ Save contact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function saveContact() {
            const input = document.getElementById('contact-input');
            const val = input.value.trim();
            if (!val) {
                showError('Please enter a phone number before saving.');
                return;
            }
            localStorage.setItem('sw_emergency_contact', val);
            showSavedBadge(val);
            clearError();
        }

        function showSavedBadge(number) {
            document.getElementById('saved-number').textContent = number;
            document.getElementById('contact-saved').classList.add('show');
        }

        // â”€â”€ Trigger SOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function triggerSOS() {
            clearError();
            showStatusCard();

            // 1. Play alarm
            startAlarm();

            // 2. Show contact row
            const contact = localStorage.getItem('sw_emergency_contact');
            showRow('contact-status');
            if (contact) {
                const smsBody = encodeURIComponent('ğŸš¨ EMERGENCY! I need help. Tracking my location now.');
                document.getElementById('contact-text').innerHTML =
                    `<a href="sms:${contact}?body=${smsBody}" target="_blank">Send SOS SMS to ${contact}</a>` +
                    ` &nbsp;|&nbsp; <a href="tel:${contact}">Call</a>`;
            } else {
                document.getElementById('contact-text').textContent = 'No contact saved â€” call 112 / 911';
            }

            // 3. Get geolocation (GPS â†’ IP fallback â†’ manual)
            showRow('location-status');
            document.getElementById('location-text').textContent = 'Fetching locationâ€¦';

            let lat = null, lon = null, locationSource = '';

            // Try GPS first
            try {
                const position = await getGPSLocation();
                lat = position.coords.latitude.toFixed(6);
                lon = position.coords.longitude.toFixed(6);
                locationSource = 'GPS';
            } catch (_gpsErr) {
                // GPS failed (file:// restriction, permission denied, or timeout) â€” try IP
                try {
                    const ipData = await getIPLocation();
                    lat = ipData.latitude.toFixed(6);
                    lon = ipData.longitude.toFixed(6);
                    locationSource = 'IP (approximate)';
                } catch (_ipErr) {
                    // Both failed
                }
            }

            if (lat !== null && lon !== null) {
                const mapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
                document.getElementById('location-text').innerHTML =
                    `<a href="${mapsUrl}" target="_blank" rel="noopener noreferrer">
          ${lat}, ${lon} â€” Open in Maps
        </a>
        <span style="font-size:11px;color:var(--text-muted);margin-left:6px;">(${locationSource})</span>`;

                // Update SMS with real location link
                if (contact) {
                    const body = encodeURIComponent(
                        `ğŸš¨ EMERGENCY! I need help. My location: ${mapsUrl}`
                    );
                    document.getElementById('contact-text').innerHTML =
                        `<a href="sms:${contact}?body=${body}" target="_blank">Send SOS SMS to ${contact}</a>` +
                        ` &nbsp;|&nbsp; <a href="tel:${contact}">Call</a>`;
                }
            } else {
                document.getElementById('location-text').innerHTML =
                    `ğŸ“µ Location unavailable â€” please share your address manually.<br>
        <a href="https://www.google.com/maps" target="_blank" rel="noopener noreferrer" style="color:var(--red)">
          Open Google Maps
        </a>`;
            }

            // Shake animation on button
            const btn = document.getElementById('sos-btn');
            btn.classList.add('active');
            setTimeout(() => btn.classList.remove('active'), 1200);
        }

        // â”€â”€ Alarm controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function startAlarm() {
            alarmAudio.currentTime = 0;
            alarmAudio.play().catch(() => {
                // Autoplay blocked â€” user interaction already happened so this should be fine
            });
            alarmPlaying = true;
            showRow('alarm-status');
            document.getElementById('alarm-text').textContent = 'Alarm is playing ğŸ”Š';
            document.getElementById('stop-btn').classList.add('show');
        }

        function stopAlarm() {
            alarmAudio.pause();
            alarmAudio.currentTime = 0;
            alarmPlaying = false;
            document.getElementById('alarm-text').textContent = 'Alarm stopped.';
            document.getElementById('stop-btn').classList.remove('show');
        }

        // â”€â”€ GPS (precise) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getGPSLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 8000,
                    maximumAge: 0,
                });
            });
        }

        // â”€â”€ IP-based fallback (approximate, works on file:// & HTTP) â”€
        function getIPLocation() {
            return fetch('https://ipapi.co/json/')
                .then(r => {
                    if (!r.ok) throw new Error('IP API error');
                    return r.json();
                })
                .then(data => {
                    if (!data.latitude) throw new Error('No coords in response');
                    return { latitude: data.latitude, longitude: data.longitude };
                });
        }

        // â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showStatusCard() {
            document.getElementById('status-card').classList.add('show');
        }

        function showRow(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function showError(msg) {
            const el = document.getElementById('error-msg');
            el.textContent = msg;
            el.classList.add('show');
        }

        function clearError() {
            document.getElementById('error-msg').classList.remove('show');
        }

        // â”€â”€ Allow Enter key to save contact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.getElementById('contact-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') saveContact();
        });
    </script>

</body>

</html>